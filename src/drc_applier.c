/****************************************************************************
 *
 *
 * Copyright (c) 2013 Dolby International AB.
 * All rights reserved.

 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 *
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in
 *    the documentation and/or other materials provided with the
 *    distribution.
 *
 * 3. Neither the name of the copyright holder nor the names of its
 *    contributors may be used to endorse or promote products derived
 *    from this software without specific prior written permission.
 *
 * NO EXPRESS OR IMPLIED LICENSES TO ANY PARTY'S PATENT RIGHTS ARE GRANTED
 * BY THIS LICENSE. THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND
 * CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING,
 * BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS
 * FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 *
 * @file
 *
 * @defgroup - Metadata emulation library private definitions
 * @{
 * Code to apply gains from DRC words to audio samples
 * @}
 */

#include "md_compr.h"
#include "drc_applier.h"

/*
 * This is a Kaiser-Bessel Derived (KBD) window with an alpha of 5.0.
 * The encode/decode process applies the window both at the input and the output,
 * so the window values must be squared before use. 
 */
static const DLB_LFRACT windowtab[256] =
{
   DLB_LcF(0.000135992220706*0.000135992220706), DLB_LcF(0.000243900754875*0.000243900754875), 
   DLB_LcF(0.000366502488193*0.000366502488193), DLB_LcF(0.000507754555407*0.000507754555407), 
   DLB_LcF(0.000670037413867*0.000670037413867), DLB_LcF(0.000855400185342*0.000855400185342), 
   DLB_LcF(0.001065821205375*0.001065821205375), DLB_LcF(0.001303288102335*0.001303288102335), 
   DLB_LcF(0.001569827978443*0.001569827978443), DLB_LcF(0.001867520148916*0.001867520148916), 
   DLB_LcF(0.002198501712923*0.002198501712923), DLB_LcF(0.002564969780604*0.002564969780604), 
   DLB_LcF(0.002969181958155*0.002969181958155), DLB_LcF(0.003413455825814*0.003413455825814), 
   DLB_LcF(0.003900167771109*0.003900167771109), DLB_LcF(0.004431751367072*0.004431751367072), 
   DLB_LcF(0.005010695400029*0.005010695400029), DLB_LcF(0.005639541607398*0.005639541607398), 
   DLB_LcF(0.006320882162124*0.006320882162124), DLB_LcF(0.007057356927055*0.007057356927055), 
   DLB_LcF(0.007851650495016*0.007851650495016), DLB_LcF(0.008706489025946*0.008706489025946), 
   DLB_LcF(0.009624636889946*0.009624636889946), DLB_LcF(0.010608893123703*0.010608893123703), 
   DLB_LcF(0.011662087706998*0.011662087706998), DLB_LcF(0.012787077665708*0.012787077665708), 
   DLB_LcF(0.013986743007667*0.013986743007667), DLB_LcF(0.015263982497866*0.015263982497866), 
   DLB_LcF(0.016621709279733*0.016621709279733), DLB_LcF(0.018062846349500*0.018062846349500), 
   DLB_LcF(0.019590321891051*0.019590321891051), DLB_LcF(0.021207064478998*0.021207064478998), 
   DLB_LcF(0.022915998158124*0.022915998158124), DLB_LcF(0.024720037407732*0.024720037407732), 
   DLB_LcF(0.026622081999825*0.026622081999825), DLB_LcF(0.028625011760421*0.028625011760421), 
   DLB_LcF(0.030731681243702*0.030731681243702), DLB_LcF(0.032944914329027*0.032944914329027), 
   DLB_LcF(0.035267498751210*0.035267498751210), DLB_LcF(0.037702180574769*0.037702180574769), 
   DLB_LcF(0.040251658623174*0.040251658623174), DLB_LcF(0.042918578874402*0.042918578874402), 
   DLB_LcF(0.045705528834356*0.045705528834356), DLB_LcF(0.048615031899956*0.048615031899956), 
   DLB_LcF(0.051649541723921*0.051649541723921), DLB_LcF(0.054811436593431*0.054811436593431), 
   DLB_LcF(0.058103013835036*0.058103013835036), DLB_LcF(0.061526484258280*0.061526484258280), 
   DLB_LcF(0.065083966650647*0.065083966650647), DLB_LcF(0.068777482336453*0.068777482336453), 
   DLB_LcF(0.072608949812408*0.072608949812408), DLB_LcF(0.076580179472524*0.076580179472524), 
   DLB_LcF(0.080692868435067*0.080692868435067), DLB_LcF(0.084948595484165*0.084948595484165), 
   DLB_LcF(0.089348816138620*0.089348816138620), DLB_LcF(0.093894857860345*0.093894857860345), 
   DLB_LcF(0.098587915414699*0.098587915414699), DLB_LcF(0.103429046394810*0.103429046394810), 
   DLB_LcF(0.108419166921769*0.108419166921769), DLB_LcF(0.113559047532332*0.113559047532332), 
   DLB_LcF(0.118849309265479*0.118849309265479), DLB_LcF(0.124290419958900*0.124290419958900), 
   DLB_LcF(0.129882690766114*0.129882690766114), DLB_LcF(0.135626272904573*0.135626272904573), 
   DLB_LcF(0.141521154644712*0.141521154644712), DLB_LcF(0.147567158549471*0.147567158549471), 
   DLB_LcF(0.153763938973368*0.153763938973368), DLB_LcF(0.160110979829739*0.160110979829739), 
   DLB_LcF(0.166607592634221*0.166607592634221), DLB_LcF(0.173252914832067*0.173252914832067), 
   DLB_LcF(0.180045908416302*0.180045908416302), DLB_LcF(0.186985358843156*0.186985358843156), 
   DLB_LcF(0.194069874250644*0.194069874250644), DLB_LcF(0.201297884985493*0.201297884985493), 
   DLB_LcF(0.208667643443034*0.208667643443034), DLB_LcF(0.216177224224004*0.216177224224004), 
   DLB_LcF(0.223824524611522*0.223824524611522), DLB_LcF(0.231607265370849*0.231607265370849), 
   DLB_LcF(0.239522991873833*0.239522991873833), DLB_LcF(0.247569075549230*0.247569075549230), 
   DLB_LcF(0.255742715659400*0.255742715659400), DLB_LcF(0.264040941403127*0.264040941403127), 
   DLB_LcF(0.272460614343606*0.272460614343606), DLB_LcF(0.280998431159907*0.280998431159907), 
   DLB_LcF(0.289650926719472*0.289650926719472), DLB_LcF(0.298414477468498*0.298414477468498), 
   DLB_LcF(0.307285305136301*0.307285305136301), DLB_LcF(0.316259480749030*0.316259480749030), 
   DLB_LcF(0.325332928947387*0.325332928947387), DLB_LcF(0.334501432602285*0.334501432602285), 
   DLB_LcF(0.343760637721643*0.343760637721643), DLB_LcF(0.353106058640861*0.353106058640861), 
   DLB_LcF(0.362533083488791*0.362533083488791), DLB_LcF(0.372036979920352*0.372036979920352), 
   DLB_LcF(0.381612901106311*0.381612901106311), DLB_LcF(0.391255891970046*0.391255891970046), 
   DLB_LcF(0.400960895660556*0.400960895660556), DLB_LcF(0.410722760250320*0.410722760250320), 
   DLB_LcF(0.420536245646053*0.420536245646053), DLB_LcF(0.430396030699861*0.430396030699861), 
   DLB_LcF(0.440296720507716*0.440296720507716), DLB_LcF(0.450232853881732*0.450232853881732), 
   DLB_LcF(0.460198910982171*0.460198910982171), DLB_LcF(0.470189321094721*0.470189321094721), 
   DLB_LcF(0.480198470538125*0.480198470538125), DLB_LcF(0.490220710686861*0.490220710686861), 
   DLB_LcF(0.500250366093228*0.500250366093228), DLB_LcF(0.510281742692860*0.510281742692860), 
   DLB_LcF(0.520309136077382*0.520309136077382), DLB_LcF(0.530326839817714*0.530326839817714), 
   DLB_LcF(0.540329153821254*0.540329153821254), DLB_LcF(0.550310392706039*0.550310392706039), 
   DLB_LcF(0.560264894174802*0.560264894174802), DLB_LcF(0.570187027371761*0.570187027371761), 
   DLB_LcF(0.580071201204886*0.580071201204886), DLB_LcF(0.589911872616390*0.589911872616390), 
   DLB_LcF(0.599703554784170*0.599703554784170), DLB_LcF(0.609440825236984*0.609440825236984), 
   DLB_LcF(0.619118333866256*0.619118333866256), DLB_LcF(0.628730810817497*0.628730810817497), 
   DLB_LcF(0.638273074244529*0.638273074244529), DLB_LcF(0.647740037909883*0.647740037909883), 
   DLB_LcF(0.657126718615012*0.657126718615012), DLB_LcF(0.666428243444219*0.666428243444219), 
   DLB_LcF(0.675639856806560*0.675639856806560), DLB_LcF(0.684756927260310*0.684756927260310), 
   DLB_LcF(0.693774954105007*0.693774954105007), DLB_LcF(0.702689573726530*0.702689573726530), 
   DLB_LcF(0.711496565681120*0.711496565681120), DLB_LcF(0.720191858504799*0.720191858504799), 
   DLB_LcF(0.728771535235165*0.728771535235165), DLB_LcF(0.737231838633147*0.737231838633147), 
   DLB_LcF(0.745569176092905*0.745569176092905), DLB_LcF(0.753780124228722*0.753780124228722), 
   DLB_LcF(0.761861433128429*0.761861433128429), DLB_LcF(0.769810030263595*0.769810030263595), 
   DLB_LcF(0.777623024047496*0.777623024047496), DLB_LcF(0.785297707032607*0.785297707032607), 
   DLB_LcF(0.792831558740230*0.792831558740230), DLB_LcF(0.800222248115628*0.800222248115628), 
   DLB_LcF(0.807467635602953*0.807467635602953), DLB_LcF(0.814565774835109*0.814565774835109), 
   DLB_LcF(0.821514913934589*0.821514913934589), DLB_LcF(0.828313496422277*0.828313496422277), 
   DLB_LcF(0.834960161732119*0.834960161732119), DLB_LcF(0.841453745330549*0.841453745330549), 
   DLB_LcF(0.847793278440539*0.847793278440539), DLB_LcF(0.853977987371108*0.853977987371108), 
   DLB_LcF(0.860007292454161*0.860007292454161), DLB_LcF(0.865880806591525*0.865880806591525), 
   DLB_LcF(0.871598333416069*0.871598333416069), DLB_LcF(0.877159865071838*0.877159865071838), 
   DLB_LcF(0.882565579619149*0.882565579619149), DLB_LcF(0.887815838071626*0.887815838071626), 
   DLB_LcF(0.892911181073185*0.892911181073185), DLB_LcF(0.897852325224003*0.897852325224003), 
   DLB_LcF(0.902640159065507*0.902640159065507), DLB_LcF(0.907275738735431*0.907275738735431), 
   DLB_LcF(0.911760283304970*0.911760283304970), DLB_LcF(0.916095169811021*0.916095169811021), 
   DLB_LcF(0.920281927997461*0.920281927997461), DLB_LcF(0.924322234780287*0.924322234780287), 
   DLB_LcF(0.928217908452397*0.928217908452397), DLB_LcF(0.931970902644557*0.931970902644557), 
   DLB_LcF(0.935583300059977*0.935583300059977), DLB_LcF(0.939057306000656*0.939057306000656), 
   DLB_LcF(0.942395241704360*0.942395241704360), DLB_LcF(0.945599537511792*0.945599537511792), 
   DLB_LcF(0.948672725884092*0.948672725884092), DLB_LcF(0.951617434291370*0.951617434291370), 
   DLB_LcF(0.954436377993422*0.954436377993422), DLB_LcF(0.957132352734224*0.957132352734224), 
   DLB_LcF(0.959708227372086*0.959708227372086), DLB_LcF(0.962166936467630*0.962166936467630), 
   DLB_LcF(0.964511472851905*0.964511472851905), DLB_LcF(0.966744880197022*0.966744880197022), 
   DLB_LcF(0.968870245611712*0.968870245611712), DLB_LcF(0.970890692284053*0.970890692284053), 
   DLB_LcF(0.972809372193462*0.972809372193462), DLB_LcF(0.974629458913707*0.974629458913707), 
   DLB_LcF(0.976354140528325*0.976354140528325), DLB_LcF(0.977986612679300*0.977986612679300), 
   DLB_LcF(0.979530071769299*0.979530071769299), DLB_LcF(0.980987708337031*0.980987708337031), 
   DLB_LcF(0.982362700624518*0.982362700624518), DLB_LcF(0.983658208354177*0.983658208354177), 
   DLB_LcF(0.984877366732626*0.984877366732626), DLB_LcF(0.986023280697078*0.986023280697078), 
   DLB_LcF(0.987099019419005*0.987099019419005), DLB_LcF(0.988107611078568*0.988107611078568), 
   DLB_LcF(0.989052037921987*0.989052037921987), DLB_LcF(0.989935231612668*0.989935231612668), 
   DLB_LcF(0.990760068885507*0.990760068885507), DLB_LcF(0.991529367512306*0.991529367512306), 
   DLB_LcF(0.992245882584776*0.992245882584776), DLB_LcF(0.992912303120028*0.992912303120028), 
   DLB_LcF(0.993531248991973*0.993531248991973), DLB_LcF(0.994105268190441*0.994105268190441), 
   DLB_LcF(0.994636834408348*0.994636834408348), DLB_LcF(0.995128344955657*0.995128344955657), 
   DLB_LcF(0.995582118997416*0.995582118997416), DLB_LcF(0.996000396111682*0.996000396111682), 
   DLB_LcF(0.996385335161687*0.996385335161687), DLB_LcF(0.996739013475303*0.996739013475303), 
   DLB_LcF(0.997063426323499*0.997063426323499), DLB_LcF(0.997360486688308*0.997360486688308), 
   DLB_LcF(0.997632025309662*0.997632025309662), DLB_LcF(0.997879790999406*0.997879790999406), 
   DLB_LcF(0.998105451209849*0.998105451209849), DLB_LcF(0.998310592843372*0.998310592843372), 
   DLB_LcF(0.998496723288847*0.998496723288847), DLB_LcF(0.998665271669997*0.998665271669997), 
   DLB_LcF(0.998817590290322*0.998817590290322), DLB_LcF(0.998954956258775*0.998954956258775), 
   DLB_LcF(0.999078573280101*0.999078573280101), DLB_LcF(0.999189573593562*0.999189573593562), 
   DLB_LcF(0.999289020043705*0.999289020043705), DLB_LcF(0.999377908266854*0.999377908266854), 
   DLB_LcF(0.999457168977167*0.999457168977167), DLB_LcF(0.999527670336312*0.999527670336312), 
   DLB_LcF(0.999590220391194*0.999590220391194), DLB_LcF(0.999645569564531*0.999645569564531), 
   DLB_LcF(0.999694413183629*0.999694413183629), DLB_LcF(0.999737394033262*0.999737394033262), 
   DLB_LcF(0.999775104919193*0.999775104919193), DLB_LcF(0.999808091229614*0.999808091229614), 
   DLB_LcF(0.999836853482484*0.999836853482484), DLB_LcF(0.999861849847578*0.999861849847578), 
   DLB_LcF(0.999883498632868*0.999883498632868), DLB_LcF(0.999902180725713*0.999902180725713), 
   DLB_LcF(0.999918241980199*0.999918241980199), DLB_LcF(0.999931995542854*0.999931995542854), 
   DLB_LcF(0.999943724109857*0.999943724109857), DLB_LcF(0.999953682109695*0.999953682109695), 
   DLB_LcF(0.999962097806132*0.999962097806132), DLB_LcF(0.999969175317171*0.999969175317171), 
   DLB_LcF(0.999975096546511*0.999975096546511), DLB_LcF(0.999980023024806*0.999980023024806), 
   DLB_LcF(0.999984097658787*0.999984097658787), DLB_LcF(0.999987446387007*0.999987446387007), 
   DLB_LcF(0.999990179741691*0.999990179741691), DLB_LcF(0.999992394316755*0.999992394316755), 
   DLB_LcF(0.999994174142692*0.999994174142692), DLB_LcF(0.999995591969534*0.999995591969534), 
   DLB_LcF(0.999996710459602*0.999996710459602), DLB_LcF(0.999997583292189*0.999997583292189), 
   DLB_LcF(0.999998256182726*0.999998256182726), DLB_LcF(0.999998767819300*0.999998767819300), 
   DLB_LcF(0.999999150719700*0.999999150719700), DLB_LcF(0.999999432012418*0.999999432012418), 
   DLB_LcF(0.999999634145195*0.999999634145195), DLB_LcF(0.999999775524907*0.999999775524907), 
   DLB_LcF(0.999999871092647*0.999999871092647), DLB_LcF(0.999999932837961*0.999999932837961), 
   DLB_LcF(0.999999970256210*0.999999970256210), DLB_LcF(0.999999990753058*0.999999990753058)
};

static const DLB_LFRACT dialnormtab[MAX_DIALNORM + 1] =
{
    DLB_LcF(0.000000000), DLB_LcF(0.031622776), DLB_LcF(0.035481338), DLB_LcF(0.039810717), // 0 - 3
    DLB_LcF(0.044668359), DLB_LcF(0.050118723), DLB_LcF(0.056234132), DLB_LcF(0.063095734), // 4 - 7
    DLB_LcF(0.070794578), DLB_LcF(0.079432823), DLB_LcF(0.089125093), DLB_LcF(0.100000000), // 8 - 11
    DLB_LcF(0.112201845), DLB_LcF(0.125892541), DLB_LcF(0.141253754), DLB_LcF(0.158489319), // 12 - 15
    DLB_LcF(0.177827941), DLB_LcF(0.199526231), DLB_LcF(0.223872113), DLB_LcF(0.251188643), // 16 - 19
    DLB_LcF(0.281838293), DLB_LcF(0.316227766), DLB_LcF(0.354813389), DLB_LcF(0.398107170), // 20 - 23
    DLB_LcF(0.446683592), DLB_LcF(0.501187233), DLB_LcF(0.562341325), DLB_LcF(0.630957344), // 24 - 27
    DLB_LcF(0.707945784), DLB_LcF(0.794328234), DLB_LcF(0.891250938), DLB_LcF(0.999999999)  // 28 - 31
};


/*
  Smooth the gain values from one block to the next.
  Apply the smoothed values to a block of audio data.

  audioBlockPtrs        - (I/O) array of pointers, one per channel. Gains are applied to samples in place
  gainValue             - (I) current gain value to apply
  lastGainValue         - (I) previous gain value to apply
  blocksize             - (I) number of samples per channel
  numchans              - (I) number of channels
  sampleOffset          - (I) offset to next sample in a channel
  chan_map              - (I) indicates which channels are present
*/

void apply_gain(DLB_LFRACT **audioBlockPtrs, DLB_LFRACT gainValue, DLB_LFRACT lastGainValue, int blocksize, int numchans, int sampleOffset, DD_EMU_CHAN_MAP *chan_map)
{
    int i, j, k;
    DLB_LFRACT *chanPtrs[DRC_MAX_NCHANS];
    DLB_LFRACT windowed_gain;

    /* limit the number of channels to a sensible value */
    if (numchans > DRC_MAX_NCHANS)      
        numchans = DRC_MAX_NCHANS;

    /* copy the block pointers so we can modify them locally */
    for (i = 0; i < numchans; ++i)
        chanPtrs[i] = audioBlockPtrs[i];

    /* iterate over the samples */
    for (i = 0, j = blocksize - 1; i < blocksize; ++i, --j)
    {
        windowed_gain = DLB_LsaddLL(DLB_LmpyLL(lastGainValue, windowtab[j]), DLB_LmpyLL(gainValue, windowtab[i]));

        /* iterate over the channels */
        for (k = 0; k < numchans; ++k)
        {
            /* apply gain, including 4 bits of headroom for boost */
            *chanPtrs[k] = DLB_LsshlLU(DLB_LmpyLL(*chanPtrs[k], windowed_gain),4); 
            chanPtrs[k] += sampleOffset;
        }
    }
}


/*
  Convert a compr value to a DLB_SFRACT gain.

  compr                 - (I) the compr value to convert

  return the compression gain as a DLB_SFRACT.
*/
DLB_LFRACT compr_to_gain(int16_t compr)
{
    char x = ((char)(compr & 0xf0) >> 4) + 8;
    int32_t z = (((int32_t)compr & 0x0f) + 0x10) << x;

    /* Normalize fractional value and allow 4 bits of headroom as max gain = 16.0 */
    return DLB_LsshlLU(DLB_L_32(z), 15);
}

/*
  Convert a dynrng value to a DLB_SFRACT gain.

  dynrng                - (I) the dynrng value to convert

  return the dynrng gain as a DLB_SFRACT.
*/
DLB_LFRACT dynrng_to_gain(int16_t dynrng)
{
    char x = ((char)(dynrng & 0xe0) >> 5) + 4;
    int32_t z = (((int32_t)dynrng & 0x1f) + 0x20) << x;

    /* Normalize fractional value and allow 4 bits of headroom as max gain = 16.0 */
    return DLB_LsshlLU(DLB_L_32(z), 18);
}

/*
  Apply dynamic range control value to audio samples.  The DRC value can be either a compr or dynrng value.

  drc_type              - (I) type of DRC: 0 = dynrng, 1 = compr
  drc_value             - (I) the DRC value, either dynrng or compr
  history               - (I/O) storage for past gain values
  dialnorm              - (I) the dialnorm value (1-31 Db)
  audioBlockPtrs        - (I/O) array of pointers, one per channel. Gains are applied to samples in place
  blocksize             - (I) number of samples per channel
  numchans              - (I) number of channels
  sampleOffset          - (I) offset to next sample in a channel
  chan_map              - (I) indicates which channels are present
  perform_boost_cut     - (I) 1 = perform boost/cut, 0 = don't
  boost                 - (I) the boost value
  cut                   - (I) the cut value
*/
/* for some reason Visual Studio doesn't know what int8_t is, even
 * though it has no problem with int16_t or int32_t */
#ifdef WIN32
#define int8_t signed char
#endif

void apply_drc(int16_t drc_type,
               int16_t drc_value,
               DLB_LFRACT *history,
               int dialnorm,
               DLB_LFRACT **audioBlockPtrs,
               int blocksize,
               int numchans,
               int sampleOffset,
               DD_EMU_CHAN_MAP *chan_map,
               int16_t perform_boost_cut,
               DLB_LFRACT boost,
               DLB_LFRACT cut
               )
{
    DLB_LFRACT gainValue;

    /* convert the DRC value to a gain according to its type */
    if (drc_type)
    {
        gainValue = compr_to_gain(drc_value);

        /* Apply 11.285 dB RF boost */
        //gainValue = DLB_LsshlLU(DLB_LmpyLL(gainValue,DLB_LcF(0.91662)),2);  
    }
    else
    {
        if (perform_boost_cut)
        {
            /*
             * Determine whether boost or cut 
             * TODO: is factor of dB or gain? 
             */
            if ((int8_t)drc_value >= 0)
            {
                drc_value = DLB_LmpyLL((int8_t)drc_value, boost);
            }
            else
            {
                drc_value = DLB_LmpyLL((int8_t)drc_value, cut);
            }
        }

        gainValue = dynrng_to_gain(drc_value);
    }

    if(dialnorm > 0 && dialnorm <= MAX_DIALNORM)
    {
        gainValue = DLB_LsmpyLL(gainValue, dialnormtab[dialnorm]);
    }


    /* apply the gain */
    apply_gain(audioBlockPtrs, gainValue, *history, blocksize, numchans, sampleOffset, chan_map);

    /* save the gain for next time */
    *history = gainValue;
}

#ifdef WIN32
#undef int8_t
#endif
